<% layout('layouts/app') -%>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Tasks</h1>
        <div class="flex space-x-2">
            <select class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <option>All Types</option>
                <option>Cleaning</option>
                <option>Maintenance</option>
                <option>Check-in</option>
                <option>Check-out</option>
                <option>Inspection</option>
            </select>
            <select class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <option>All Status</option>
                <option>Pending</option>
                <option>In Progress</option>
                <option>Completed</option>
            </select>
        </div>
    </div>

    <!-- Tasks Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <% tasks.forEach(task => { %>
            <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-1"><%= task.title %></h3>
                        <p class="text-sm text-gray-600"><%= task.property_name || 'General Task' %></p>
                    </div>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                        <% if (task.status === 'pending') { %>bg-yellow-100 text-yellow-800<% } %>
                        <% if (task.status === 'in_progress') { %>bg-blue-100 text-blue-800<% } %>
                        <% if (task.status === 'completed') { %>bg-green-100 text-green-800<% } %>">
                        <%= task.status.replace('_', ' ') %>
                    </span>
                </div>
                
                <% if (task.description) { %>
                    <p class="text-gray-700 mb-4"><%= task.description %></p>
                <% } %>
                
                <div class="space-y-2 mb-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <i data-lucide="tag" class="w-4 h-4 mr-2"></i>
                        <span class="capitalize"><%= task.type %></span>
                    </div>
                    
                    <% if (task.assigned_name) { %>
                        <div class="flex items-center text-sm text-gray-600">
                            <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                            <span><%= task.assigned_name %></span>
                        </div>
                    <% } %>
                    
                    <% if (task.due_date) { %>
                        <div class="flex items-center text-sm text-gray-600">
                            <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                            <span><%= new Date(task.due_date).toLocaleString() %></span>
                        </div>
                    <% } %>
                </div>
                
                <div class="flex space-x-2">
                    <% if (task.status === 'pending') { %>
                        <button onclick="updateTaskStatus(<%= task.id %>, 'in_progress')" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Start
                        </button>
                    <% } %>
                    
                    <% if (task.status === 'in_progress') { %>
                        <button onclick="updateTaskStatus(<%= task.id %>, 'completed')" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Complete
                        </button>
                    <% } %>
                    
                    <% if (task.status === 'completed') { %>
                        <button onclick="updateTaskStatus(<%= task.id %>, 'pending')" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Reopen
                        </button>
                    <% } %>
                </div>
            </div>
        <% }) %>
    </div>

    <% if (tasks.length === 0) { %>
        <div class="text-center py-12">
            <i data-lucide="check-square" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks yet</h3>
            <p class="text-gray-600">Tasks will be automatically created for bookings and can be added manually.</p>
        </div>
    <% } %>
</div>

<script>
function updateTaskStatus(taskId, status) {
    fetch(`/tasks/${taskId}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating task status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
    });
}
</script>